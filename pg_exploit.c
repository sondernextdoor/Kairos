#include "pg_context.h"
#include "../common/utilities.h"

#define PG_SIGNATURE_1 0x4D6F6E69746F7244ULL  // "MonitorD"

extern PVOID GetKernelBase(void);
extern ULONG GetKernelSize(void);

ULONGLONG LastPatchGuardActivation(void) {
    ULONGLONG lastActivationTime = 0;
    PVOID kernelBase = GetKernelBase();
    ULONG kernelSize = GetKernelSize();

    for (ULONG offset = 0; offset < kernelSize; offset += 16) {
        PUINT64 address = (PUINT64)((ULONG_PTR)kernelBase + offset);
        if (*address == PG_SIGNATURE_1) {
            PVOID potentialCtx = ValidatePgContext(address);
            if (potentialCtx) {
                UCHAR pgKey[32] = {0};
                UCHAR decryptedBuffer[sizeof(DECRYPTED_PG_CONTEXT)] = {0};
                ExtractPgEncryptionKey(potentialCtx, pgKey);
                if (NT_SUCCESS(DecryptPatchGuardContext(pgKey, sizeof(pgKey),
                        (PUCHAR)potentialCtx + PG_CTX_ENCRYPTED_OFFSET,
                        decryptedBuffer, sizeof(decryptedBuffer)))) {
                    DECRYPTED_PG_CONTEXT* ctx = (DECRYPTED_PG_CONTEXT*)decryptedBuffer;
                    if (ctx->ValidationRoutine &&
                        ctx->LastCheckTime < ctx->NextCheckTime &&
                        ctx->LastCheckTime > lastActivationTime) {
                        lastActivationTime = ctx->LastCheckTime;
                    }
                }
            }
        }
    }

    DebugLog("LastPatchGuardActivation = 0x%llX\n", lastActivationTime);
    return lastActivationTime;
}
